#!/usr/bin/env bash

set -uo pipefail
IFS=$'\n\t'

# Setup getops flags.
ENV="development"

usage() {
  echo "Usage: $0 <args>" >&2
  echo "  -d  Run setup for development env (default)"
  echo "  -p  Run setup for production env"
}

while getopts "dp:h" flag; do
  case "${flag}" in
    d) ENV="development" ;;
    p) ENV="production" ;;
    h) usage; exit 0 ;;
    *) usage; exit 1 ;;
  esac
done

echo "Running setup for environment: $ENV"
sleep 1

# Configure bundler based on environment.
if [ "$ENV" == "production" ]; then
  bundle config set --local deployment true
  bundle config set --local without development test
  bundle config set --local clean true
else
  bundle config set --local without production
fi

# Install gem dependencies.
bundle install

# Duplicate example config file.
ROOT_DIR="$(dirname "${BASH_SOURCE[0]}")/.."
cp -nv "$ROOT_DIR/config/config.example.yml" "$ROOT_DIR/config/config.yml"

# Don't duplicate .env in production; duplicate schedule only in production.
if [ "$ENV" == "production" ]; then
  cp -nv "$ROOT_DIR/config/schedule.example.rb" "$ROOT_DIR/config/schedule.rb"
else
  cp -nv "$ROOT_DIR/.env-example" "$ROOT_DIR/.env"
fi
